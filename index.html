<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Magic Wheel - QuÃªte des multiplications</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700&display=swap" rel="stylesheet" />
    <style>
      :root {
        color-scheme: light;
        --bg: linear-gradient(160deg, #f5f3ff 0%, #f0f9ff 45%, #fff5fb 100%);
        --surface: rgba(255, 255, 255, 0.92);
        --surface-strong: #ffffff;
        --primary: #6c5ce7;
        --primary-dark: #4f3ac8;
        --accent: #ff7f50;
        --muted: #5e5a80;
        --text: #2f1c6a;
        --success: #00b894;
        --shadow: 0 30px 70px -40px rgba(65, 48, 110, 0.35);
        --shadow-soft: 0 18px 45px -38px rgba(65, 48, 110, 0.25);
      }

      * {
        box-sizing: border-box;
      }

      body.quest-home {
        margin: 0;
        min-height: 100vh;
        background: var(--bg);
        color: var(--text);
        font-family: "Baloo 2", "Segoe UI", Tahoma, sans-serif;
        display: flex;
        flex-direction: column;
      }

      img {
        max-width: 100%;
        height: auto;
        display: block;
      }

      main.quest {
        width: min(1100px, 92%);
        margin: 0 auto;
        padding: clamp(2rem, 6vw, 4rem) 0 4rem;
        display: grid;
        gap: clamp(1.75rem, 4vw, 2.8rem);
        flex: 1;
      }

      .panel {
        background: var(--surface);
        border-radius: 28px;
        padding: clamp(1.6rem, 4vw, 2.6rem);
        box-shadow: var(--shadow);
        display: grid;
        gap: 1.2rem;
      }

      .intro {
        text-align: center;
        background: var(--surface-strong);
        box-shadow: var(--shadow);
      }

      .intro__badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.35rem 1.3rem;
        border-radius: 999px;
        background: rgba(108, 92, 231, 0.1);
        color: var(--primary-dark);
        font-weight: 600;
        font-size: 0.95rem;
      }

      .intro h1 {
        margin: 0;
        font-size: clamp(2.4rem, 5vw, 3.6rem);
        color: var(--primary);
      }

      .intro p {
        margin: 0;
        font-size: clamp(1.1rem, 3vw, 1.35rem);
        color: var(--muted);
      }

      h2 {
        margin: 0;
        font-size: clamp(1.8rem, 4vw, 2.4rem);
        color: var(--primary-dark);
      }

      .selector-grid,
      .level-grid {
        display: grid;
        gap: clamp(1rem, 3vw, 1.6rem);
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }

      button.character-card,
      button.level-card {
        border: 2px solid transparent;
        border-radius: 24px;
        padding: clamp(1.1rem, 3vw, 1.5rem);
        text-align: left;
        background: var(--surface);
        box-shadow: var(--shadow-soft);
        color: inherit;
        font-family: inherit;
        cursor: pointer;
        display: grid;
        gap: 0.65rem;
        transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.2s ease;
      }

      button.character-card:hover,
      button.level-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow);
      }

      button.character-card[data-selected="true"],
      button.level-card[data-selected="true"] {
        border-color: var(--primary);
        background: var(--surface-strong);
        box-shadow: var(--shadow);
      }

      .character-card__portrait {
        border-radius: 20px;
        overflow: hidden;
        background: rgba(108, 92, 231, 0.08);
        aspect-ratio: 4 / 3;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .character-card__portrait img {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }

      .character-card__name {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--primary-dark);
      }

      .character-card__role {
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--accent);
      }

      .character-card__text {
        font-size: 0.95rem;
        color: var(--muted);
      }

      .level-card__badge {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.4rem 0.9rem;
        border-radius: 999px;
        background: rgba(255, 127, 80, 0.12);
        color: var(--accent);
        font-weight: 600;
        font-size: 0.9rem;
      }

      .level-card__title {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--primary-dark);
      }

      .level-card__range {
        font-size: 0.98rem;
        font-weight: 600;
        color: var(--primary);
      }

      .level-card__text {
        font-size: 0.95rem;
        color: var(--muted);
      }

      .panel--launch {
        justify-items: center;
        text-align: center;
      }

      .panel__note {
        margin: 0;
        font-size: 1.05rem;
        color: var(--muted);
      }

      .primary-btn {
        border: none;
        border-radius: 18px;
        padding: 0.95rem 2.4rem;
        font-size: 1.1rem;
        font-weight: 700;
        background: linear-gradient(120deg, var(--primary), #8e7bff);
        color: #fff;
        box-shadow: var(--shadow-soft);
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
        font-family: inherit;
      }

      .primary-btn:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: var(--shadow);
      }

      .primary-btn:disabled {
        opacity: 0.6;
        cursor: default;
        box-shadow: none;
        transform: none;
      }

      .quest-story {
        background: var(--surface-strong);
      }

      .quest-story__header {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
      }

      .quest-story__duration {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
        color: var(--primary-dark);
      }

      .quest-story__intro,
      .quest-story__conclusion {
        margin: 0;
        font-size: 1.05rem;
        color: var(--muted);
      }

      .chapter-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: grid;
        gap: 1.1rem;
      }

      .chapter {
        background: rgba(108, 92, 231, 0.08);
        border-radius: 22px;
        padding: clamp(1.2rem, 3vw, 1.6rem);
        border: 2px solid transparent;
        display: grid;
        gap: 0.7rem;
        position: relative;
      }

      .chapter__header {
        display: grid;
        grid-template-columns: auto 1fr auto;
        align-items: center;
        gap: 0.75rem;
      }

      .chapter__header--interactive {
        cursor: pointer;
      }

      .chapter__header--interactive:focus-visible {
        outline: none;
        box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.25);
        border-radius: 16px;
        background: rgba(108, 92, 231, 0.12);
      }

      .chapter__tag {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.35rem 0.85rem;
        border-radius: 999px;
        background: rgba(108, 92, 231, 0.18);
        color: var(--primary-dark);
        font-weight: 600;
        font-size: 0.95rem;
      }

      .chapter__title-wrap {
        display: grid;
        gap: 0.2rem;
      }

      .chapter__title {
        margin: 0;
        font-size: 1.25rem;
        color: var(--primary-dark);
      }

      .chapter__duration {
        font-size: 0.95rem;
        color: var(--muted);
        font-weight: 600;
      }

      .chapter__chevron {
        width: 1.5rem;
        height: 1.5rem;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: rgba(108, 92, 231, 0.18);
        color: var(--primary-dark);
        font-size: 0.85rem;
        transition: transform 0.2s ease;
      }

      .chapter__body {
        display: grid;
        gap: 0.7rem;
      }

      .chapter__illustration {
        margin: 0;
        border-radius: 18px;
        overflow: hidden;
        background: rgba(108, 92, 231, 0.12);
      }

      .chapter__illustration img {
        width: 100%;
        height: auto;
        display: block;
      }

      .chapter__illustration figcaption {
        margin: 0;
        padding: 0.6rem 0.9rem;
        font-size: 0.85rem;
        color: var(--muted);
        background: rgba(255, 255, 255, 0.8);
      }

      .chapter__narrative,
      .chapter__meta,
      .chapter__tip {
        margin: 0;
        font-size: 0.98rem;
        color: var(--muted);
      }

      .chapter__game {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
        color: var(--primary);
      }

      .chapter__actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
      }

      .chapter--collapsed .chapter__body {
        display: none;
      }

      .chapter--collapsed .chapter__chevron {
        transform: rotate(-90deg);
      }

      .chapter__link {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.75rem 1.6rem;
        border-radius: 18px;
        background: var(--primary);
        color: #fff;
        font-weight: 700;
        text-decoration: none;
        box-shadow: var(--shadow-soft);
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }

      .chapter__link:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow);
      }

      .chapter__mark {
        border: none;
        border-radius: 18px;
        padding: 0.75rem 1.4rem;
        font-weight: 600;
        font-size: 0.95rem;
        background: rgba(108, 92, 231, 0.12);
        color: var(--primary-dark);
        cursor: pointer;
        font-family: inherit;
        transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.2s ease;
      }

      .chapter__mark:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-soft);
      }

      .chapter[data-completed="true"] {
        border-color: var(--success);
        background: rgba(0, 184, 148, 0.08);
      }

      .chapter[data-completed="true"] .chapter__tag {
        background: rgba(0, 184, 148, 0.15);
        color: var(--success);
      }

      .chapter[data-completed="true"] .chapter__mark {
        background: rgba(0, 184, 148, 0.12);
        color: var(--success);
      }

      .section-header {
        display: flex;
        flex-wrap: wrap;
        align-items: baseline;
        justify-content: space-between;
        gap: 0.75rem;
      }

      .section-header p {
        margin: 0;
        color: var(--muted);
      }

      .table-section {
        background: var(--surface-strong);
      }

      .table-grid {
        display: grid;
        gap: 1rem;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      }

      .table-card {
        background: rgba(108, 92, 231, 0.08);
        border-radius: 20px;
        padding: 1.2rem 1.4rem;
        display: grid;
        gap: 0.5rem;
      }

      .table-card h3 {
        margin: 0;
        font-size: 1.1rem;
        color: var(--primary-dark);
      }

      .table-card ul {
        margin: 0;
        padding-left: 1.1rem;
        color: var(--muted);
        display: grid;
        gap: 0.15rem;
        font-size: 0.95rem;
      }

      footer.quest-footer {
        margin: 0;
        padding: 2.2rem 0 2.6rem;
        text-align: center;
        font-size: 0.95rem;
        color: var(--muted);
      }

      @media (max-width: 720px) {
        .quest-story__header {
          flex-direction: column;
          align-items: flex-start;
        }
        .chapter__actions {
          flex-direction: column;
          align-items: stretch;
        }
        .chapter__link,
        .chapter__mark {
          width: 100%;
          justify-content: center;
        }
      }
    </style>
  </head>
  <body class="quest-home">
    <main class="quest">
      <section class="panel intro">
        <span class="intro__badge">â¨ Nouvelle aventure</span>
        <h1>Choisis ton hÃ©ros et lance la quÃªte</h1>
        <p>
          Trois mini-jeux reliÃ©s par une histoire Ã  vivre en moins de 10 minutes.
          SÃ©lectionne ton compagnon et le niveau pour partir en mission.
        </p>
      </section>

      <section class="panel">
        <h2>1. Choisis ton personnage</h2>
        <p class="panel__note">
          Chaque hÃ©ros dispose de son style : trouve celui qui te motive le plus.
        </p>
        <div class="selector-grid" id="character-options"></div>
      </section>

      <section class="panel">
        <h2>2. Choisis le niveau</h2>
        <p class="panel__note">
          Les tables proposÃ©es s'adaptent Ã  ton choix pour garder une difficultÃ© cohÃ©rente.
        </p>
        <div class="level-grid" id="level-options"></div>
      </section>

      <section class="panel panel--launch">
        <p class="panel__note" id="setup-note">
          Choisis un hÃ©ros et un niveau pour prÃ©parer la mission.
        </p>
        <button class="primary-btn" id="start-quest" type="button" disabled>
          Lancer la quÃªte
        </button>
      </section>

      <section class="panel quest-story" id="quest-story" hidden>
        <div class="quest-story__header">
          <h2 id="quest-story-title">Ta lÃ©gende commence</h2>
          <p class="quest-story__duration" id="quest-duration"></p>
        </div>
        <p class="quest-story__intro" id="quest-story-intro"></p>
        <ol class="chapter-list" id="quest-chapters"></ol>
        <p class="quest-story__conclusion" id="quest-conclusion"></p>
      </section>

      <section class="panel table-section" id="tables">
        <div class="section-header">
          <h2>ð¢ Tables de rÃ©fÃ©rence</h2>
          <p>Garde ce mÃ©mo sous la main pendant ta quÃªte.</p>
        </div>
        <div class="table-grid">
          <article class="table-card">
            <h3>Table de 1</h3>
            <ul>
              <li>1 Ã 1 = 1</li>
              <li>1 Ã 2 = 2</li>
              <li>1 Ã 3 = 3</li>
              <li>1 Ã 4 = 4</li>
              <li>1 Ã 5 = 5</li>
              <li>1 Ã 6 = 6</li>
              <li>1 Ã 7 = 7</li>
              <li>1 Ã 8 = 8</li>
              <li>1 Ã 9 = 9</li>
              <li>1 Ã 10 = 10</li>
            </ul>
          </article>
          <article class="table-card">
            <h3>Table de 2</h3>
            <ul>
              <li>2 Ã 1 = 2</li>
              <li>2 Ã 2 = 4</li>
              <li>2 Ã 3 = 6</li>
              <li>2 Ã 4 = 8</li>
              <li>2 Ã 5 = 10</li>
              <li>2 Ã 6 = 12</li>
              <li>2 Ã 7 = 14</li>
              <li>2 Ã 8 = 16</li>
              <li>2 Ã 9 = 18</li>
              <li>2 Ã 10 = 20</li>
            </ul>
          </article>
          <article class="table-card">
            <h3>Table de 3</h3>
            <ul>
              <li>3 Ã 1 = 3</li>
              <li>3 Ã 2 = 6</li>
              <li>3 Ã 3 = 9</li>
              <li>3 Ã 4 = 12</li>
              <li>3 Ã 5 = 15</li>
              <li>3 Ã 6 = 18</li>
              <li>3 Ã 7 = 21</li>
              <li>3 Ã 8 = 24</li>
              <li>3 Ã 9 = 27</li>
              <li>3 Ã 10 = 30</li>
            </ul>
          </article>
          <article class="table-card">
            <h3>Table de 4</h3>
            <ul>
              <li>4 Ã 1 = 4</li>
              <li>4 Ã 2 = 8</li>
              <li>4 Ã 3 = 12</li>
              <li>4 Ã 4 = 16</li>
              <li>4 Ã 5 = 20</li>
              <li>4 Ã 6 = 24</li>
              <li>4 Ã 7 = 28</li>
              <li>4 Ã 8 = 32</li>
              <li>4 Ã 9 = 36</li>
              <li>4 Ã 10 = 40</li>
            </ul>
          </article>
          <article class="table-card">
            <h3>Table de 5</h3>
            <ul>
              <li>5 Ã 1 = 5</li>
              <li>5 Ã 2 = 10</li>
              <li>5 Ã 3 = 15</li>
              <li>5 Ã 4 = 20</li>
              <li>5 Ã 5 = 25</li>
              <li>5 Ã 6 = 30</li>
              <li>5 Ã 7 = 35</li>
              <li>5 Ã 8 = 40</li>
              <li>5 Ã 9 = 45</li>
              <li>5 Ã 10 = 50</li>
            </ul>
          </article>
          <article class="table-card">
            <h3>Table de 6</h3>
            <ul>
              <li>6 Ã 1 = 6</li>
              <li>6 Ã 2 = 12</li>
              <li>6 Ã 3 = 18</li>
              <li>6 Ã 4 = 24</li>
              <li>6 Ã 5 = 30</li>
              <li>6 Ã 6 = 36</li>
              <li>6 Ã 7 = 42</li>
              <li>6 Ã 8 = 48</li>
              <li>6 Ã 9 = 54</li>
              <li>6 Ã 10 = 60</li>
            </ul>
          </article>
          <article class="table-card">
            <h3>Table de 7</h3>
            <ul>
              <li>7 Ã 1 = 7</li>
              <li>7 Ã 2 = 14</li>
              <li>7 Ã 3 = 21</li>
              <li>7 Ã 4 = 28</li>
              <li>7 Ã 5 = 35</li>
              <li>7 Ã 6 = 42</li>
              <li>7 Ã 7 = 49</li>
              <li>7 Ã 8 = 56</li>
              <li>7 Ã 9 = 63</li>
              <li>7 Ã 10 = 70</li>
            </ul>
          </article>
          <article class="table-card">
            <h3>Table de 8</h3>
            <ul>
              <li>8 Ã 1 = 8</li>
              <li>8 Ã 2 = 16</li>
              <li>8 Ã 3 = 24</li>
              <li>8 Ã 4 = 32</li>
              <li>8 Ã 5 = 40</li>
              <li>8 Ã 6 = 48</li>
              <li>8 Ã 7 = 56</li>
              <li>8 Ã 8 = 64</li>
              <li>8 Ã 9 = 72</li>
              <li>8 Ã 10 = 80</li>
            </ul>
          </article>
          <article class="table-card">
            <h3>Table de 9</h3>
            <ul>
              <li>9 Ã 1 = 9</li>
              <li>9 Ã 2 = 18</li>
              <li>9 Ã 3 = 27</li>
              <li>9 Ã 4 = 36</li>
              <li>9 Ã 5 = 45</li>
              <li>9 Ã 6 = 54</li>
              <li>9 Ã 7 = 63</li>
              <li>9 Ã 8 = 72</li>
              <li>9 Ã 9 = 81</li>
              <li>9 Ã 10 = 90</li>
            </ul>
          </article>
          <article class="table-card">
            <h3>Table de 10</h3>
            <ul>
              <li>10 Ã 1 = 10</li>
              <li>10 Ã 2 = 20</li>
              <li>10 Ã 3 = 30</li>
              <li>10 Ã 4 = 40</li>
              <li>10 Ã 5 = 50</li>
              <li>10 Ã 6 = 60</li>
              <li>10 Ã 7 = 70</li>
              <li>10 Ã 8 = 80</li>
              <li>10 Ã 9 = 90</li>
              <li>10 Ã 10 = 100</li>
            </ul>
          </article>
        </div>
      </section>
    </main>

    <footer class="quest-footer">
      Â© Magic Wheel â Une aventure de tables en moins de 10 minutes.
    </footer>

    <script>
      (function () {
        const QUEST_STORAGE_KEY = "mw-quest-selection";
        const characters = buildCharacters();
        const levels = buildLevels();
        const levelMap = levels.reduce(function (map, level) {
          map[level.id] = level;
          return map;
        }, {});

        const storedSelection = loadQuestSelection();
        const chapterElements = [];

        const characterContainer = document.getElementById("character-options");
        const levelContainer = document.getElementById("level-options");
        const startButton = document.getElementById("start-quest");
        const setupNote = document.getElementById("setup-note");
        const storySection = document.getElementById("quest-story");
        const storyTitle = document.getElementById("quest-story-title");
        const storyIntro = document.getElementById("quest-story-intro");
        const storyDuration = document.getElementById("quest-duration");
        const chapterList = document.getElementById("quest-chapters");
        const storyConclusion = document.getElementById("quest-conclusion");

        const characterButtons = [];
        const levelButtons = [];

        let selectedHero = null;
        let selectedLevelId = null;
        let questVisible = false;

        renderCharacters();
        renderLevels();

        const storedHeroId = storedSelection && storedSelection.hero ? storedSelection.hero.id : null;
        const storedLevelId = storedSelection && storedSelection.level ? storedSelection.level.id : null;

        if (storedHeroId) {
          const hero = characters.find(function (item) {
            return item.id === storedHeroId;
          });
          if (hero) {
            selectHero(hero);
          }
        }

        if (storedLevelId) {
          selectLevel(storedLevelId);
        }

        updateStartState();

        if (startButton) {
          startButton.addEventListener("click", function () {
            if (!selectedHero || !selectedLevelId) {
              return;
            }
            renderQuest();
          });
        }

        function renderCharacters() {
          if (!characterContainer) {
            return;
          }
          characterButtons.length = 0;
          characterContainer.innerHTML = "";

          characters.forEach(function (hero) {
            const button = document.createElement("button");
            button.type = "button";
            button.className = "character-card";
            button.dataset.character = hero.id;
            button.dataset.selected = "false";
            button.setAttribute("aria-pressed", "false");
            button.innerHTML = `
              <span class="character-card__portrait">
                <img src="${hero.image}" alt="${hero.alt}" loading="lazy" />
              </span>
              <span class="character-card__name">${hero.name}</span>
              <span class="character-card__role">${hero.role}</span>
              <span class="character-card__text">${hero.description}</span>
            `;

            button.addEventListener("click", function () {
              const isSelected = selectedHero && selectedHero.id === hero.id;
              selectHero(isSelected ? null : hero);
            });

            button.addEventListener("keydown", function (event) {
              if (event.key === "Enter" || event.key === " ") {
                event.preventDefault();
                const isSelected = selectedHero && selectedHero.id === hero.id;
                selectHero(isSelected ? null : hero);
              }
            });

            characterButtons.push(button);
            characterContainer.append(button);
          });
        }

        function renderLevels() {
          if (!levelContainer) {
            return;
          }
          levelButtons.length = 0;
          levelContainer.innerHTML = "";

          levels.forEach(function (level) {
            const button = document.createElement("button");
            button.type = "button";
            button.className = "level-card";
            button.dataset.level = level.id;
            button.dataset.selected = "false";
            button.setAttribute("aria-pressed", "false");
            button.innerHTML = `
              <span class="level-card__badge">${level.label}</span>
              <span class="level-card__title">${level.shortName}</span>
              <span class="level-card__range">${level.range}</span>
              <span class="level-card__text">${level.summary}</span>
            `;

            button.addEventListener("click", function () {
              const isSelected = selectedLevelId === level.id;
              selectLevel(isSelected ? null : level.id);
            });

            button.addEventListener("keydown", function (event) {
              if (event.key === "Enter" || event.key === " ") {
                event.preventDefault();
                const isSelected = selectedLevelId === level.id;
                selectLevel(isSelected ? null : level.id);
              }
            });

            levelButtons.push(button);
            levelContainer.append(button);
          });
        }

        function selectHero(hero) {
          selectedHero = hero;
          characterButtons.forEach(function (button) {
            const isActive = hero && button.dataset.character === hero.id;
            button.dataset.selected = isActive ? "true" : "false";
            button.classList.toggle("character-card--selected", isActive);
            button.setAttribute("aria-pressed", isActive ? "true" : "false");
          });
          if (questVisible) {
            hideQuest();
          }
          persistSelection();
          updateStartState();
        }

        function selectLevel(levelId) {
          selectedLevelId = levelId;
          levelButtons.forEach(function (button) {
            const isActive = levelId && button.dataset.level === levelId;
            button.dataset.selected = isActive ? "true" : "false";
            button.classList.toggle("level-card--selected", isActive);
            button.setAttribute("aria-pressed", isActive ? "true" : "false");
          });
          if (questVisible) {
            hideQuest();
          }
          persistSelection();
          updateStartState();
        }

        function updateStartState() {
          const ready = Boolean(selectedHero && selectedLevelId);
          if (startButton) {
            startButton.disabled = !ready;
          }
          updateSetupNote();
        }

        function updateSetupNote() {
          if (!setupNote) {
            return;
          }
          const level = selectedLevelId ? levelMap[selectedLevelId] : null;
          let message = "Choisis un hÃ©ros et un niveau pour prÃ©parer la mission.";

          if (selectedHero && level) {
            const total = estimateTotal(level);
            message = `${selectedHero.name} se prÃ©pare pour la quÃªte Â« ${level.shortName} Â» (â ${total} min).`;
          } else if (selectedHero) {
            message = `${selectedHero.name} attend ton choix de niveau.`;
          } else if (level) {
            message = `Choisis un hÃ©ros pour guider la mission Â« ${level.shortName} Â».`;
          }

          setupNote.textContent = message;
        }

        function renderQuest() {
          const level = selectedLevelId ? levelMap[selectedLevelId] : null;
          if (!level || !selectedHero) {
            return;
          }

          if (storyTitle) {
            storyTitle.textContent = `${level.label} â ${level.shortName}`;
          }

          if (storyIntro) {
            storyIntro.textContent = formatStory(level.intro);
          }

          if (storyDuration) {
            const total = estimateTotal(level);
            storyDuration.textContent = total ? `DurÃ©e totale estimÃ©e : â ${total} min` : "";
            storyDuration.hidden = !total;
          }

          if (chapterList) {
            chapterList.innerHTML = "";
            chapterElements.length = 0;
            level.steps.forEach(function (step, index) {
              const chapter = createChapter(step, index);
              chapterElements.push(chapter);
              chapterList.append(chapter);
            });
            chapterElements.forEach(function (item, index) {
              setChapterExpanded(item, index === 0);
            });
          }

          if (storyConclusion) {
            storyConclusion.textContent = formatStory(level.conclusion);
          }

          if (storySection) {
            storySection.hidden = false;
            storySection.scrollIntoView({ behavior: "smooth", block: "start" });
          }

          questVisible = true;
          if (startButton) {
            startButton.textContent = "Relancer la quÃªte";
          }
        }

        function hideQuest() {
          if (!questVisible) {
            return;
          }
          if (storySection) {
            storySection.hidden = true;
          }
          questVisible = false;
          if (startButton) {
            startButton.textContent = "Lancer la quÃªte";
          }
        }

        function createChapter(step, index) {
          const item = document.createElement("li");
          item.className = "chapter";
          item.dataset.completed = "false";
          item.dataset.index = String(index);
          item.dataset.expanded = "false";

          const header = document.createElement("div");
          header.className = "chapter__header chapter__header--interactive";
          header.tabIndex = 0;
          header.setAttribute("role", "button");
          header.setAttribute("aria-expanded", "false");

          const tag = document.createElement("span");
          tag.className = "chapter__tag";
          tag.textContent = `Chapitre ${index + 1}`;
          header.append(tag);

          const titleWrapper = document.createElement("div");
          titleWrapper.className = "chapter__title-wrap";

          if (step.title) {
            const title = document.createElement("h3");
            title.className = "chapter__title";
            title.textContent = step.title;
            titleWrapper.append(title);
          }

          if (typeof step.duration === "number" && step.duration > 0) {
            const duration = document.createElement("span");
            duration.className = "chapter__duration";
            duration.textContent = `â ${step.duration} min`;
            titleWrapper.append(duration);
          }

          header.append(titleWrapper);

          const chevron = document.createElement("span");
          chevron.className = "chapter__chevron";
          chevron.setAttribute("aria-hidden", "true");
          chevron.textContent = "â¾";
          header.append(chevron);

          header.addEventListener("click", function () {
            toggleChapter(item);
          });

          header.addEventListener("keydown", function (event) {
            if (event.key === "Enter" || event.key === " ") {
              event.preventDefault();
              toggleChapter(item);
            }
          });

          item.append(header);

          const body = document.createElement("div");
          body.className = "chapter__body";

          if (step.image) {
            const figure = document.createElement("figure");
            figure.className = "chapter__illustration";
            const image = document.createElement("img");
            image.src = step.image;
            image.alt = step.imageAlt || step.title || "Illustration de la mission";
            image.loading = "lazy";
            figure.append(image);
            if (step.imageCaption) {
              const caption = document.createElement("figcaption");
              caption.textContent = step.imageCaption;
              figure.append(caption);
            }
            body.append(figure);
          }

          if (step.narrative) {
            const narrative = document.createElement("p");
            narrative.className = "chapter__narrative";
            narrative.textContent = formatStory(step.narrative);
            body.append(narrative);
          }

          if (step.game) {
            const game = document.createElement("p");
            game.className = "chapter__game";
            game.innerHTML = `<strong>Jeu :</strong> ${step.game}`;
            body.append(game);
          }

          if (step.tableSummary) {
            const tables = document.createElement("p");
            tables.className = "chapter__meta";
            tables.textContent = step.tableSummary;
            body.append(tables);
          }

          if (step.tip) {
            const tip = document.createElement("p");
            tip.className = "chapter__tip";
            tip.textContent = step.tip;
            body.append(tip);
          }

          const actions = document.createElement("div");
          actions.className = "chapter__actions";

          if (step.actionUrl) {
            const link = document.createElement("a");
            link.className = "chapter__link";
            link.href = step.actionUrl;
            link.target = "_blank";
            link.rel = "noopener";
            link.textContent = step.actionLabel || "Lancer le mini-jeu";
            actions.append(link);
          }

          const mark = document.createElement("button");
          mark.type = "button";
          mark.className = "chapter__mark";
          mark.textContent = "Marquer comme terminÃ©";
          mark.setAttribute("aria-pressed", "false");
          mark.addEventListener("click", function () {
            const completed = item.dataset.completed === "true";
            const nextState = !completed;
            item.dataset.completed = nextState ? "true" : "false";
            mark.textContent = nextState ? "Chapitre terminÃ© â" : "Marquer comme terminÃ©";
            mark.setAttribute("aria-pressed", nextState ? "true" : "false");
            if (nextState) {
              expandChapterByIndex(index + 1, true);
            } else {
              collapseChaptersAfter(index);
            }
          });
          actions.append(mark);

          body.append(actions);
          item.append(body);
          return item;
        }

        function setChapterExpanded(item, expanded) {
          if (!item) {
            return;
          }
          item.dataset.expanded = expanded ? "true" : "false";
          updateChapterExpansion(item);
        }

        function toggleChapter(item) {
          if (!item) {
            return;
          }
          const isExpanded = item.dataset.expanded === "true";
          setChapterExpanded(item, !isExpanded);
        }

        function expandChapterByIndex(index, focus) {
          if (index < 0 || index >= chapterElements.length) {
            return;
          }
          const target = chapterElements[index];
          setChapterExpanded(target, true);
          if (focus && target) {
            target.scrollIntoView({ behavior: "smooth", block: "start" });
          }
        }

        function collapseChaptersAfter(index) {
          for (let i = index + 1; i < chapterElements.length; i += 1) {
            setChapterExpanded(chapterElements[i], false);
          }
        }

        function updateChapterExpansion(item) {
          if (!item) {
            return;
          }
          const header = item.querySelector(".chapter__header");
          const body = item.querySelector(".chapter__body");
          const isExpanded = item.dataset.expanded === "true";
          item.classList.toggle("chapter--collapsed", !isExpanded);
          if (header) {
            header.setAttribute("aria-expanded", isExpanded ? "true" : "false");
          }
          if (body) {
            body.hidden = !isExpanded;
          }
        }

        function estimateTotal(level) {
          if (!level || !Array.isArray(level.steps)) {
            return 0;
          }
          return level.steps.reduce(function (sum, step) {
            return sum + (typeof step.duration === "number" ? step.duration : 0);
          }, 0);
        }

        function formatStory(template) {
          if (!template) {
            return "";
          }
          if (!selectedHero) {
            return template;
          }
          return template.replace(/\{hero\}/g, selectedHero.name);
        }

        function persistSelection() {
          if (typeof window === "undefined" || !window.localStorage) {
            return;
          }

          const level = selectedLevelId ? levelMap[selectedLevelId] : null;
          const heroData = selectedHero
            ? {
                id: selectedHero.id,
                name: selectedHero.name,
                image: selectedHero.image,
                alt: selectedHero.alt
              }
            : null;

          const levelData = level
            ? {
                id: level.id,
                label: level.label,
                shortName: level.shortName,
                range: level.range
              }
            : selectedLevelId
            ? { id: selectedLevelId }
            : null;

          const tables = level && Array.isArray(level.missionTables) ? level.missionTables : [];

          if (!heroData && !levelData) {
            window.localStorage.removeItem(QUEST_STORAGE_KEY);
            return;
          }

          try {
            window.localStorage.setItem(
              QUEST_STORAGE_KEY,
              JSON.stringify({
                hero: heroData,
                level: levelData,
                tables: tables
              })
            );
          } catch (error) {
            // ignore storage errors (quota, private mode...)
          }
        }

        function loadQuestSelection() {
          if (typeof window === "undefined" || !window.localStorage) {
            return null;
          }

          try {
            const raw = window.localStorage.getItem(QUEST_STORAGE_KEY);
            if (!raw) {
              return null;
            }
            const parsed = JSON.parse(raw);
            if (!parsed || typeof parsed !== "object") {
              return null;
            }
            if (Array.isArray(parsed.tables)) {
              const sanitized = [];
              const seen = {};
              parsed.tables.forEach(function (value) {
                const number = Number(value);
                if (
                  Number.isInteger(number) &&
                  number >= 1 &&
                  number <= 10 &&
                  !seen[number]
                ) {
                  seen[number] = true;
                  sanitized.push(number);
                }
              });
              sanitized.sort(function (a, b) {
                return a - b;
              });
              parsed.tables = sanitized;
            } else {
              parsed.tables = [];
            }
            return parsed;
          } catch (error) {
            return null;
          }
        }

        function buildCharacters() {
          return [
            {
              id: "chevalier",
              name: "Chevalier Ardent",
              role: "Bouclier Ã©tincelant",
              description: "Courageux et loyal, il dÃ©fend chaque village avec son Ã©pÃ©e lumineuse.",
              image: "assets/chevalier.png",
              alt: "Chevalier Ardent brandissant son Ã©pÃ©e"
            },
            {
              id: "magicienne",
              name: "Magicienne Solaire",
              role: "Sorts de lumiÃ¨re",
              description: "Ses runes brillent autant que ses idÃ©es pour rÃ©soudre les Ã©nigmes.",
              image: "assets/magicienne.png",
              alt: "Magicienne Solaire invoquant un sort"
            },
            {
              id: "exploratrice",
              name: "Exploratrice Stella",
              role: "StratÃ©gies malignes",
              description: "Elle cartographie chaque recoin et trouve le chemin le plus malin.",
              image: "assets/princesse.png",
              alt: "Exploratrice Stella observant une carte Ã©toilÃ©e"
            }
          ];
        }

        function buildLevels() {
          return [
            {
              id: "1",
              label: "Niveau 1",
              shortName: "ForÃªt des Apprentis",
              range: "Tables 1 Ã  3, avec un soupÃ§on de 4",
              summary: "IdÃ©al pour consolider les bases en douceur.",
              intro: "Les feux follets ont volÃ© le cristal du village. {hero} doit le rÃ©cupÃ©rer avant que la nuit ne tombe.",
              conclusion: "GrÃ¢ce Ã  sa tÃ©nacitÃ©, {hero} ramÃ¨ne le cristal et la forÃªt s'illumine de nouveau.",
              missionTables: [1, 2, 3],
              steps: [
                {
                  id: "grimoire",
                  title: "VeillÃ©e au camp",
                  narrative: "{hero} rassemble les fragments du grimoire pour retrouver la trace des lucioles voleuses.",
                  duration: 3,
                  game: "Memory multi",
                  actionLabel: "Ouvrir Memory multi",
                  actionUrl: buildMemoryUrl(2),
                  tableSummary: "Table ciblÃ©e : 2 (rappels des tables 1 et 3).",
                  tip: "Assemble les 6 paires pour reconstituer la carte lumineuse.",
                  image: "assets/chateau.png",
                  imageAlt: "Campement illuminÃ© dans une clairiÃ¨re enchantÃ©e",
                  imageCaption: "Le bivouac reprend vie quand les fragments du grimoire sont rÃ©unis."
                },
                {
                  id: "clairiere",
                  title: "Course dans la clairiÃ¨re",
                  narrative: "En suivant les lucioles, {hero} rÃ©cite les sorts des tables 1 Ã  3 pour ouvrir les portails.",
                  duration: 3,
                  game: "Roulette magique",
                  actionLabel: "Lancer Roulette magique",
                  actionUrl: buildRouletteUrl([1, 2, 3]),
                  tableSummary: "Tables 1 Ã  3, avec quelques dÃ©fis de la table 4.",
                  tip: "15 secondes par question, ne laisse pas la clairiÃ¨re s'assombrir !",
                  image: "assets/gobelin.png",
                  imageAlt: "Gobelin filant avec une lanterne magique",
                  imageCaption: "Cours aprÃ¨s les gobelins avant qu'ils ne referment les portails."
                },
                {
                  id: "pont",
                  title: "L'esprit du pont",
                  narrative: "Le gardien de pierre teste {hero} avec des affirmations de multiplication.",
                  duration: 3,
                  game: "Duel Vrai ou Faux",
                  actionLabel: "DÃ©fier l'esprit",
                  actionUrl: buildTrueFalseUrl([1, 2, 3, 4], "apprenti"),
                  tableSummary: "Tables 1 Ã  3 et quelques touches de la table 4.",
                  tip: "Tu disposes de 12 secondes pour valider chaque sort.",
                  image: "assets/dragon.png",
                  imageAlt: "Esprit draconique sculptÃ© gardant un pont de pierre",
                  imageCaption: "RÃ©ponds juste pour que l'esprit du pont te laisse passer."
                }
              ]
            },
            {
              id: "2",
              label: "Niveau 2",
              shortName: "Montagnes Obsidiennes",
              range: "Tables 4 Ã  6, avec une pointe de 7",
              summary: "Parfait pour gagner en rythme avant les grands dÃ©fis.",
              intro: "Les trolls de pierre ont bloquÃ© les mines obsidiennes. {hero} doit rouvrir le passage avant la prochaine lune.",
              conclusion: "{hero} libÃ¨re les cristaux et les mineurs peuvent Ã  nouveau voyager.",
              missionTables: [4, 5, 6],
              steps: [
                {
                  id: "sentinelles",
                  title: "Sentinelles de pierre",
                  narrative: "{hero} rÃ©cupÃ¨re les runes auprÃ¨s des statues pour ouvrir la montagne.",
                  duration: 3,
                  game: "Memory multi",
                  actionLabel: "Ouvrir Memory multi",
                  actionUrl: buildMemoryUrl(5),
                  tableSummary: "Table ciblÃ©e : 5 (rappels des tables 4 Ã  6).",
                  tip: "Retrouve vite les 6 paires gardÃ©es par les trolls.",
                  image: "assets/chevalier noir.png",
                  imageAlt: "Statue de chevalier sombre gardant l'entrÃ©e d'une mine",
                  imageCaption: "Rassemble les runes gravÃ©es sur les sentinelles de pierre."
                },
                {
                  id: "ascension",
                  title: "Ascension des Montagnes Obsidiennes",
                  narrative: "Chaque cavitÃ© s'ouvre en rÃ©citant les tables 4 Ã  6 avec prÃ©cision.",
                  duration: 3,
                  game: "Roulette magique",
                  actionLabel: "Lancer Roulette magique",
                  actionUrl: buildRouletteUrl([4, 5, 6]),
                  tableSummary: "Tables 4 Ã  6 avec quelques incursions de la table 7.",
                  tip: "15 secondes par question : maintiens le rythme d'un chevalier.",
                  image: "assets/chevalier.png",
                  imageAlt: "Chevalier gravissant un passage escarpÃ©",
                  imageCaption: "Grimpe vers les sommets obsidiens sans perdre ton souffle."
                },
                {
                  id: "coeur",
                  title: "Le cÅur de la montagne",
                  narrative: "Le golem final vÃ©rifie les calculs avant de relÃ¢cher la gemme.",
                  duration: 3,
                  game: "Duel Vrai ou Faux",
                  actionLabel: "Affronter le golem",
                  actionUrl: buildTrueFalseUrl([4, 5, 6, 7], "chevalier"),
                  tableSummary: "Tables 4 Ã  6 et quelques questions de la table 7.",
                  tip: "8 secondes par question, reste concentrÃ© jusqu'au bout.",
                  image: "assets/coffre.png",
                  imageAlt: "Relique magique reposant dans un coffre ancien",
                  imageCaption: "Le cÅur de la montagne renferme un trÃ©sor qui rÃ©agit Ã  tes rÃ©ponses."
                }
              ]
            },
            {
              id: "3",
              label: "Niveau 3",
              shortName: "DÃ©sert des ChimÃ¨res",
              range: "Tables 7 Ã  9 uniquement",
              summary: "Une mission intense pour maÃ®triser les tables Ã©levÃ©es.",
              intro: "Le dÃ©sert des ChimÃ¨res menace d'engloutir l'oasis sacrÃ©e. {hero} doit sceller la faille avant le coucher du soleil.",
              conclusion: "Le dragon apaise la tempÃªte et {hero} gagne une relique ancestrale.",
              missionTables: [7, 8, 9],
              steps: [
                {
                  id: "ruines",
                  title: "Ruines des chimÃ¨res",
                  narrative: "{hero} rÃ©cupÃ¨re les glyphes oubliÃ©s du dÃ©sert brÃ»lant.",
                  duration: 3,
                  game: "Memory multi",
                  actionLabel: "Ouvrir Memory multi",
                  actionUrl: buildMemoryUrl(8),
                  tableSummary: "Table ciblÃ©e : 8 (rappels des tables 7 Ã  9).",
                  tip: "Assemble les paires avant que la tempÃªte de sable n'arrive.",
                  image: "assets/sorciere.png",
                  imageAlt: "Mage des sables levant un bÃ¢ton runique",
                  imageCaption: "Collecte les glyphes perdus dans les ruines brÃ»lantes."
                },
                {
                  id: "mirages",
                  title: "Course Ã  travers les mirages",
                  narrative: "Les chimÃ¨res invoquent des mirages multipliÃ©s, {hero} doit rÃ©pondre vite.",
                  duration: 3,
                  game: "Roulette magique",
                  actionLabel: "Lancer Roulette magique",
                  actionUrl: buildRouletteUrl([7, 8, 9]),
                  tableSummary: "Tables 7 Ã  9 uniquement.",
                  tip: "15 secondes par question, garde ton sang-froid.",
                  image: "assets/princesse.png",
                  imageAlt: "Exploratrice avanÃ§ant dans un dÃ©sert Ã©tincelant",
                  imageCaption: "Fonce entre les mirages sans perdre le fil des multiplications."
                },
                {
                  id: "temple",
                  title: "Temple du dragon sableux",
                  narrative: "Le dragon du dÃ©sert lance des affirmations brÃ»lantes.",
                  duration: 3,
                  game: "Duel Vrai ou Faux",
                  actionLabel: "Affronter le dragon",
                  actionUrl: buildTrueFalseUrl([7, 8, 9], "dragon"),
                  tableSummary: "Tables 7 Ã  9 uniquement.",
                  tip: "5 secondes par question : rÃ©ponds sans hÃ©siter !",
                  image: "assets/dragon.png",
                  imageAlt: "Dragon de sable dÃ©ployant ses ailes devant un temple",
                  imageCaption: "Triomphe du dragon pour sceller le dÃ©sert des ChimÃ¨res."
                }
              ]
            }
          ];
        }

        function buildMemoryUrl(table) {
          const value = Number(table);
          if (!Number.isInteger(value) || value < 1 || value > 10) {
            return "memory.html";
          }
          return `memory.html?table=${value}`;
        }

        function buildRouletteUrl(tables) {
          const values = sanitizeTables(tables);
          if (!values.length) {
            return "jeu.html";
          }
          return `jeu.html?mode=classic&tables=${values.join(",")}`;
        }

        function buildTrueFalseUrl(tables, difficulty) {
          const values = sanitizeTables(tables);
          let url = "vf.html";
          if (values.length) {
            url += `?tables=${values.join(",")}`;
          }
          if (difficulty) {
            url += values.length ? `&difficulty=${encodeURIComponent(difficulty)}` : `?difficulty=${encodeURIComponent(difficulty)}`;
          }
          return url;
        }

        function sanitizeTables(list) {
          if (!Array.isArray(list)) {
            return [];
          }
          const seen = {};
          const result = [];
          list.forEach(function (value) {
            const number = Number(value);
            if (Number.isInteger(number) && number >= 1 && number <= 10 && !seen[number]) {
              seen[number] = true;
              result.push(number);
            }
          });
          result.sort(function (a, b) {
            return a - b;
          });
          return result;
        }
      })();
    </script>
  </body>
</html>
