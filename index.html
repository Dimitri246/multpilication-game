<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Magic Wheel - Qu√™te des multiplications</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700&display=swap" rel="stylesheet" />
    <style>
      :root {
        color-scheme: light;
        --bg: linear-gradient(160deg, #f5f3ff 0%, #f0f9ff 45%, #fff5fb 100%);
        --surface: rgba(255, 255, 255, 0.92);
        --surface-strong: #ffffff;
        --primary: #6c5ce7;
        --primary-dark: #4f3ac8;
        --accent: #ff7f50;
        --muted: #5e5a80;
        --text: #2f1c6a;
        --success: #00b894;
        --shadow: 0 30px 70px -40px rgba(65, 48, 110, 0.35);
        --shadow-soft: 0 18px 45px -38px rgba(65, 48, 110, 0.25);
      }

      * {
        box-sizing: border-box;
      }

      body.quest-home {
        margin: 0;
        min-height: 100vh;
        background: var(--bg);
        color: var(--text);
        font-family: "Baloo 2", "Segoe UI", Tahoma, sans-serif;
        display: flex;
        flex-direction: column;
      }

      img {
        max-width: 100%;
        height: auto;
        display: block;
      }

      main.quest {
        width: min(1100px, 92%);
        margin: 0 auto;
        padding: clamp(2rem, 6vw, 4rem) 0 4rem;
        display: grid;
        gap: clamp(1.75rem, 4vw, 2.8rem);
        flex: 1;
      }

      .panel {
        background: var(--surface);
        border-radius: 28px;
        padding: clamp(1.6rem, 4vw, 2.6rem);
        box-shadow: var(--shadow);
        display: grid;
        gap: 1.2rem;
      }

      .intro {
        text-align: center;
        background: var(--surface-strong);
        box-shadow: var(--shadow);
      }

      .intro__badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.35rem 1.3rem;
        border-radius: 999px;
        background: rgba(108, 92, 231, 0.1);
        color: var(--primary-dark);
        font-weight: 600;
        font-size: 0.95rem;
      }

      .intro h1 {
        margin: 0;
        font-size: clamp(2.4rem, 5vw, 3.6rem);
        color: var(--primary);
      }

      .intro p {
        margin: 0;
        font-size: clamp(1.1rem, 3vw, 1.35rem);
        color: var(--muted);
      }

      h2 {
        margin: 0;
        font-size: clamp(1.8rem, 4vw, 2.4rem);
        color: var(--primary-dark);
      }

      .selector-grid,
      .level-grid {
        display: grid;
        gap: clamp(1rem, 3vw, 1.6rem);
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }

      button.character-card,
      button.level-card {
        border: 2px solid transparent;
        border-radius: 24px;
        padding: clamp(1.1rem, 3vw, 1.5rem);
        text-align: left;
        background: var(--surface);
        box-shadow: var(--shadow-soft);
        color: inherit;
        font-family: inherit;
        cursor: pointer;
        display: grid;
        gap: 0.65rem;
        transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.2s ease;
      }

      button.character-card:hover,
      button.level-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow);
      }

      button.character-card[data-selected="true"],
      button.level-card[data-selected="true"] {
        border-color: var(--primary);
        background: var(--surface-strong);
        box-shadow: var(--shadow);
      }

      .character-card__portrait {
        border-radius: 20px;
        overflow: hidden;
        background: rgba(108, 92, 231, 0.08);
        aspect-ratio: 4 / 3;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .character-card__portrait img {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }

      .character-card__name {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--primary-dark);
      }

      .character-card__role {
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--accent);
      }

      .character-card__text {
        font-size: 0.95rem;
        color: var(--muted);
      }

      .level-card__badge {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.4rem 0.9rem;
        border-radius: 999px;
        background: rgba(255, 127, 80, 0.12);
        color: var(--accent);
        font-weight: 600;
        font-size: 0.9rem;
      }

      .level-card__title {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--primary-dark);
      }

      .level-card__range {
        font-size: 0.98rem;
        font-weight: 600;
        color: var(--primary);
      }

      .level-card__text {
        font-size: 0.95rem;
        color: var(--muted);
      }

      .panel--launch {
        justify-items: center;
        text-align: center;
      }

      .panel__note {
        margin: 0;
        font-size: 1.05rem;
        color: var(--muted);
      }

      .primary-btn {
        border: none;
        border-radius: 18px;
        padding: 0.95rem 2.4rem;
        font-size: 1.1rem;
        font-weight: 700;
        background: linear-gradient(120deg, var(--primary), #8e7bff);
        color: #fff;
        box-shadow: var(--shadow-soft);
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
        font-family: inherit;
      }

      .primary-btn:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: var(--shadow);
      }

      .primary-btn:disabled {
        opacity: 0.6;
        cursor: default;
        box-shadow: none;
        transform: none;
      }

      .quest-story {
        background: var(--surface-strong);
      }

      .quest-story__header {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
      }

      .quest-story__duration {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
        color: var(--primary-dark);
      }

      .quest-story__intro,
      .quest-story__conclusion {
        margin: 0;
        font-size: 1.05rem;
        color: var(--muted);
      }

      .chapter-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: grid;
        gap: 1.1rem;
      }

      .chapter {
        background: rgba(108, 92, 231, 0.08);
        border-radius: 22px;
        padding: clamp(1.2rem, 3vw, 1.6rem);
        border: 2px solid transparent;
        display: grid;
        gap: 0.7rem;
      }

      .chapter__header {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
      }

      .chapter__tag {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.35rem 0.85rem;
        border-radius: 999px;
        background: rgba(108, 92, 231, 0.18);
        color: var(--primary-dark);
        font-weight: 600;
        font-size: 0.95rem;
      }

      .chapter__duration {
        font-size: 0.95rem;
        color: var(--muted);
        font-weight: 600;
      }

      .chapter__title {
        margin: 0;
        font-size: 1.25rem;
        color: var(--primary-dark);
      }

      .chapter__narrative,
      .chapter__meta,
      .chapter__tip {
        margin: 0;
        font-size: 0.98rem;
        color: var(--muted);
      }

      .chapter__game {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
        color: var(--primary);
      }

      .chapter__actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
      }

      .chapter__link {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.75rem 1.6rem;
        border-radius: 18px;
        background: var(--primary);
        color: #fff;
        font-weight: 700;
        text-decoration: none;
        box-shadow: var(--shadow-soft);
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }

      .chapter__link:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow);
      }

      .chapter__mark {
        border: none;
        border-radius: 18px;
        padding: 0.75rem 1.4rem;
        font-weight: 600;
        font-size: 0.95rem;
        background: rgba(108, 92, 231, 0.12);
        color: var(--primary-dark);
        cursor: pointer;
        font-family: inherit;
        transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.2s ease;
      }

      .chapter__mark:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-soft);
      }

      .chapter[data-completed="true"] {
        border-color: var(--success);
        background: rgba(0, 184, 148, 0.08);
      }

      .chapter[data-completed="true"] .chapter__tag {
        background: rgba(0, 184, 148, 0.15);
        color: var(--success);
      }

      .chapter[data-completed="true"] .chapter__mark {
        background: rgba(0, 184, 148, 0.12);
        color: var(--success);
      }

      .section-header {
        display: flex;
        flex-wrap: wrap;
        align-items: baseline;
        justify-content: space-between;
        gap: 0.75rem;
      }

      .section-header p {
        margin: 0;
        color: var(--muted);
      }

      .table-section {
        background: var(--surface-strong);
      }

      .table-grid {
        display: grid;
        gap: 1rem;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      }

      .table-card {
        background: rgba(108, 92, 231, 0.08);
        border-radius: 20px;
        padding: 1.2rem 1.4rem;
        display: grid;
        gap: 0.5rem;
      }

      .table-card h3 {
        margin: 0;
        font-size: 1.1rem;
        color: var(--primary-dark);
      }

      .table-card ul {
        margin: 0;
        padding-left: 1.1rem;
        color: var(--muted);
        display: grid;
        gap: 0.15rem;
        font-size: 0.95rem;
      }

      footer.quest-footer {
        margin: 0;
        padding: 2.2rem 0 2.6rem;
        text-align: center;
        font-size: 0.95rem;
        color: var(--muted);
      }

      @media (max-width: 720px) {
        .quest-story__header {
          flex-direction: column;
          align-items: flex-start;
        }
        .chapter__actions {
          flex-direction: column;
          align-items: stretch;
        }
        .chapter__link,
        .chapter__mark {
          width: 100%;
          justify-content: center;
        }
      }
    </style>
  </head>
  <body class="quest-home">
    <main class="quest">
      <section class="panel intro">
        <span class="intro__badge">‚ú® Nouvelle aventure</span>
        <h1>Choisis ton h√©ros et lance la qu√™te</h1>
        <p>
          Trois mini-jeux reli√©s par une histoire √† vivre en moins de 10 minutes.
          S√©lectionne ton compagnon et le niveau pour partir en mission.
        </p>
      </section>

      <section class="panel">
        <h2>1. Choisis ton personnage</h2>
        <p class="panel__note">
          Chaque h√©ros dispose de son style : trouve celui qui te motive le plus.
        </p>
        <div class="selector-grid" id="character-options"></div>
      </section>

      <section class="panel">
        <h2>2. Choisis le niveau</h2>
        <p class="panel__note">
          Les tables propos√©es s'adaptent √† ton choix pour garder une difficult√© coh√©rente.
        </p>
        <div class="level-grid" id="level-options"></div>
      </section>

      <section class="panel panel--launch">
        <p class="panel__note" id="setup-note">
          Choisis un h√©ros et un niveau pour pr√©parer la mission.
        </p>
        <button class="primary-btn" id="start-quest" type="button" disabled>
          Lancer la qu√™te
        </button>
      </section>

      <section class="panel quest-story" id="quest-story" hidden>
        <div class="quest-story__header">
          <h2 id="quest-story-title">Ta l√©gende commence</h2>
          <p class="quest-story__duration" id="quest-duration"></p>
        </div>
        <p class="quest-story__intro" id="quest-story-intro"></p>
        <ol class="chapter-list" id="quest-chapters"></ol>
        <p class="quest-story__conclusion" id="quest-conclusion"></p>
      </section>

      <section class="panel table-section" id="tables">
        <div class="section-header">
          <h2>üî¢ Tables de r√©f√©rence</h2>
          <p>Garde ce m√©mo sous la main pendant ta qu√™te.</p>
        </div>
        <div class="table-grid">
          <article class="table-card">
            <h3>Table de 1</h3>
            <ul>
              <li>1 √ó 1 = 1</li>
              <li>1 √ó 2 = 2</li>
              <li>1 √ó 3 = 3</li>
              <li>1 √ó 4 = 4</li>
              <li>1 √ó 5 = 5</li>
              <li>1 √ó 6 = 6</li>
              <li>1 √ó 7 = 7</li>
              <li>1 √ó 8 = 8</li>
              <li>1 √ó 9 = 9</li>
              <li>1 √ó 10 = 10</li>
            </ul>
          </article>
          <article class="table-card">
            <h3>Table de 2</h3>
            <ul>
              <li>2 √ó 1 = 2</li>
              <li>2 √ó 2 = 4</li>
              <li>2 √ó 3 = 6</li>
              <li>2 √ó 4 = 8</li>
              <li>2 √ó 5 = 10</li>
              <li>2 √ó 6 = 12</li>
              <li>2 √ó 7 = 14</li>
              <li>2 √ó 8 = 16</li>
              <li>2 √ó 9 = 18</li>
              <li>2 √ó 10 = 20</li>
            </ul>
          </article>
          <article class="table-card">
            <h3>Table de 3</h3>
            <ul>
              <li>3 √ó 1 = 3</li>
              <li>3 √ó 2 = 6</li>
              <li>3 √ó 3 = 9</li>
              <li>3 √ó 4 = 12</li>
              <li>3 √ó 5 = 15</li>
              <li>3 √ó 6 = 18</li>
              <li>3 √ó 7 = 21</li>
              <li>3 √ó 8 = 24</li>
              <li>3 √ó 9 = 27</li>
              <li>3 √ó 10 = 30</li>
            </ul>
          </article>
          <article class="table-card">
            <h3>Table de 4</h3>
            <ul>
              <li>4 √ó 1 = 4</li>
              <li>4 √ó 2 = 8</li>
              <li>4 √ó 3 = 12</li>
              <li>4 √ó 4 = 16</li>
              <li>4 √ó 5 = 20</li>
              <li>4 √ó 6 = 24</li>
              <li>4 √ó 7 = 28</li>
              <li>4 √ó 8 = 32</li>
              <li>4 √ó 9 = 36</li>
              <li>4 √ó 10 = 40</li>
            </ul>
          </article>
          <article class="table-card">
            <h3>Table de 5</h3>
            <ul>
              <li>5 √ó 1 = 5</li>
              <li>5 √ó 2 = 10</li>
              <li>5 √ó 3 = 15</li>
              <li>5 √ó 4 = 20</li>
              <li>5 √ó 5 = 25</li>
              <li>5 √ó 6 = 30</li>
              <li>5 √ó 7 = 35</li>
              <li>5 √ó 8 = 40</li>
              <li>5 √ó 9 = 45</li>
              <li>5 √ó 10 = 50</li>
            </ul>
          </article>
          <article class="table-card">
            <h3>Table de 6</h3>
            <ul>
              <li>6 √ó 1 = 6</li>
              <li>6 √ó 2 = 12</li>
              <li>6 √ó 3 = 18</li>
              <li>6 √ó 4 = 24</li>
              <li>6 √ó 5 = 30</li>
              <li>6 √ó 6 = 36</li>
              <li>6 √ó 7 = 42</li>
              <li>6 √ó 8 = 48</li>
              <li>6 √ó 9 = 54</li>
              <li>6 √ó 10 = 60</li>
            </ul>
          </article>
          <article class="table-card">
            <h3>Table de 7</h3>
            <ul>
              <li>7 √ó 1 = 7</li>
              <li>7 √ó 2 = 14</li>
              <li>7 √ó 3 = 21</li>
              <li>7 √ó 4 = 28</li>
              <li>7 √ó 5 = 35</li>
              <li>7 √ó 6 = 42</li>
              <li>7 √ó 7 = 49</li>
              <li>7 √ó 8 = 56</li>
              <li>7 √ó 9 = 63</li>
              <li>7 √ó 10 = 70</li>
            </ul>
          </article>
          <article class="table-card">
            <h3>Table de 8</h3>
            <ul>
              <li>8 √ó 1 = 8</li>
              <li>8 √ó 2 = 16</li>
              <li>8 √ó 3 = 24</li>
              <li>8 √ó 4 = 32</li>
              <li>8 √ó 5 = 40</li>
              <li>8 √ó 6 = 48</li>
              <li>8 √ó 7 = 56</li>
              <li>8 √ó 8 = 64</li>
              <li>8 √ó 9 = 72</li>
              <li>8 √ó 10 = 80</li>
            </ul>
          </article>
          <article class="table-card">
            <h3>Table de 9</h3>
            <ul>
              <li>9 √ó 1 = 9</li>
              <li>9 √ó 2 = 18</li>
              <li>9 √ó 3 = 27</li>
              <li>9 √ó 4 = 36</li>
              <li>9 √ó 5 = 45</li>
              <li>9 √ó 6 = 54</li>
              <li>9 √ó 7 = 63</li>
              <li>9 √ó 8 = 72</li>
              <li>9 √ó 9 = 81</li>
              <li>9 √ó 10 = 90</li>
            </ul>
          </article>
          <article class="table-card">
            <h3>Table de 10</h3>
            <ul>
              <li>10 √ó 1 = 10</li>
              <li>10 √ó 2 = 20</li>
              <li>10 √ó 3 = 30</li>
              <li>10 √ó 4 = 40</li>
              <li>10 √ó 5 = 50</li>
              <li>10 √ó 6 = 60</li>
              <li>10 √ó 7 = 70</li>
              <li>10 √ó 8 = 80</li>
              <li>10 √ó 9 = 90</li>
              <li>10 √ó 10 = 100</li>
            </ul>
          </article>
        </div>
      </section>
    </main>

    <footer class="quest-footer">
      ¬© Magic Wheel ‚Äî Une aventure de tables en moins de 10 minutes.
    </footer>

    <script>
      (function () {
        const characters = buildCharacters();
        const levels = buildLevels();
        const levelMap = levels.reduce(function (map, level) {
          map[level.id] = level;
          return map;
        }, {});

        const characterContainer = document.getElementById("character-options");
        const levelContainer = document.getElementById("level-options");
        const startButton = document.getElementById("start-quest");
        const setupNote = document.getElementById("setup-note");
        const storySection = document.getElementById("quest-story");
        const storyTitle = document.getElementById("quest-story-title");
        const storyIntro = document.getElementById("quest-story-intro");
        const storyDuration = document.getElementById("quest-duration");
        const chapterList = document.getElementById("quest-chapters");
        const storyConclusion = document.getElementById("quest-conclusion");

        const characterButtons = [];
        const levelButtons = [];

        let selectedHero = null;
        let selectedLevelId = null;
        let questVisible = false;

        renderCharacters();
        renderLevels();
        updateStartState();

        if (startButton) {
          startButton.addEventListener("click", function () {
            if (!selectedHero || !selectedLevelId) {
              return;
            }
            renderQuest();
          });
        }

        function renderCharacters() {
          if (!characterContainer) {
            return;
          }
          characterButtons.length = 0;
          characterContainer.innerHTML = "";

          characters.forEach(function (hero) {
            const button = document.createElement("button");
            button.type = "button";
            button.className = "character-card";
            button.dataset.character = hero.id;
            button.dataset.selected = "false";
            button.setAttribute("aria-pressed", "false");
            button.innerHTML = `
              <span class="character-card__portrait">
                <img src="${hero.image}" alt="${hero.alt}" loading="lazy" />
              </span>
              <span class="character-card__name">${hero.name}</span>
              <span class="character-card__role">${hero.role}</span>
              <span class="character-card__text">${hero.description}</span>
            `;

            button.addEventListener("click", function () {
              const isSelected = selectedHero && selectedHero.id === hero.id;
              selectHero(isSelected ? null : hero);
            });

            button.addEventListener("keydown", function (event) {
              if (event.key === "Enter" || event.key === " ") {
                event.preventDefault();
                const isSelected = selectedHero && selectedHero.id === hero.id;
                selectHero(isSelected ? null : hero);
              }
            });

            characterButtons.push(button);
            characterContainer.append(button);
          });
        }

        function renderLevels() {
          if (!levelContainer) {
            return;
          }
          levelButtons.length = 0;
          levelContainer.innerHTML = "";

          levels.forEach(function (level) {
            const button = document.createElement("button");
            button.type = "button";
            button.className = "level-card";
            button.dataset.level = level.id;
            button.dataset.selected = "false";
            button.setAttribute("aria-pressed", "false");
            button.innerHTML = `
              <span class="level-card__badge">${level.label}</span>
              <span class="level-card__title">${level.shortName}</span>
              <span class="level-card__range">${level.range}</span>
              <span class="level-card__text">${level.summary}</span>
            `;

            button.addEventListener("click", function () {
              const isSelected = selectedLevelId === level.id;
              selectLevel(isSelected ? null : level.id);
            });

            button.addEventListener("keydown", function (event) {
              if (event.key === "Enter" || event.key === " ") {
                event.preventDefault();
                const isSelected = selectedLevelId === level.id;
                selectLevel(isSelected ? null : level.id);
              }
            });

            levelButtons.push(button);
            levelContainer.append(button);
          });
        }

        function selectHero(hero) {
          selectedHero = hero;
          characterButtons.forEach(function (button) {
            const isActive = hero && button.dataset.character === hero.id;
            button.dataset.selected = isActive ? "true" : "false";
            button.classList.toggle("character-card--selected", isActive);
            button.setAttribute("aria-pressed", isActive ? "true" : "false");
          });
          if (questVisible) {
            hideQuest();
          }
          updateStartState();
        }

        function selectLevel(levelId) {
          selectedLevelId = levelId;
          levelButtons.forEach(function (button) {
            const isActive = levelId && button.dataset.level === levelId;
            button.dataset.selected = isActive ? "true" : "false";
            button.classList.toggle("level-card--selected", isActive);
            button.setAttribute("aria-pressed", isActive ? "true" : "false");
          });
          if (questVisible) {
            hideQuest();
          }
          updateStartState();
        }

        function updateStartState() {
          const ready = Boolean(selectedHero && selectedLevelId);
          if (startButton) {
            startButton.disabled = !ready;
          }
          updateSetupNote();
        }

        function updateSetupNote() {
          if (!setupNote) {
            return;
          }
          const level = selectedLevelId ? levelMap[selectedLevelId] : null;
          let message = "Choisis un h√©ros et un niveau pour pr√©parer la mission.";

          if (selectedHero && level) {
            const total = estimateTotal(level);
            message = `${selectedHero.name} se pr√©pare pour la qu√™te ¬´ ${level.shortName} ¬ª (‚âà ${total} min).`;
          } else if (selectedHero) {
            message = `${selectedHero.name} attend ton choix de niveau.`;
          } else if (level) {
            message = `Choisis un h√©ros pour guider la mission ¬´ ${level.shortName} ¬ª.`;
          }

          setupNote.textContent = message;
        }

        function renderQuest() {
          const level = selectedLevelId ? levelMap[selectedLevelId] : null;
          if (!level || !selectedHero) {
            return;
          }

          if (storyTitle) {
            storyTitle.textContent = `${level.label} ‚Äî ${level.shortName}`;
          }

          if (storyIntro) {
            storyIntro.textContent = formatStory(level.intro);
          }

          if (storyDuration) {
            const total = estimateTotal(level);
            storyDuration.textContent = total ? `Dur√©e totale estim√©e : ‚âà ${total} min` : "";
            storyDuration.hidden = !total;
          }

          if (chapterList) {
            chapterList.innerHTML = "";
            level.steps.forEach(function (step, index) {
              chapterList.append(createChapter(step, index));
            });
          }

          if (storyConclusion) {
            storyConclusion.textContent = formatStory(level.conclusion);
          }

          if (storySection) {
            storySection.hidden = false;
            storySection.scrollIntoView({ behavior: "smooth", block: "start" });
          }

          questVisible = true;
          if (startButton) {
            startButton.textContent = "Relancer la qu√™te";
          }
        }

        function hideQuest() {
          if (!questVisible) {
            return;
          }
          if (storySection) {
            storySection.hidden = true;
          }
          questVisible = false;
          if (startButton) {
            startButton.textContent = "Lancer la qu√™te";
          }
        }

        function createChapter(step, index) {
          const item = document.createElement("li");
          item.className = "chapter";
          item.dataset.completed = "false";

          const header = document.createElement("div");
          header.className = "chapter__header";

          const tag = document.createElement("span");
          tag.className = "chapter__tag";
          tag.textContent = `Chapitre ${index + 1}`;
          header.append(tag);

          if (typeof step.duration === "number" && step.duration > 0) {
            const duration = document.createElement("span");
            duration.className = "chapter__duration";
            duration.textContent = `‚âà ${step.duration} min`;
            header.append(duration);
          }

          item.append(header);

          if (step.title) {
            const title = document.createElement("h3");
            title.className = "chapter__title";
            title.textContent = step.title;
            item.append(title);
          }

          if (step.narrative) {
            const narrative = document.createElement("p");
            narrative.className = "chapter__narrative";
            narrative.textContent = formatStory(step.narrative);
            item.append(narrative);
          }

          if (step.game) {
            const game = document.createElement("p");
            game.className = "chapter__game";
            game.innerHTML = `<strong>Jeu :</strong> ${step.game}`;
            item.append(game);
          }

          if (step.tableSummary) {
            const tables = document.createElement("p");
            tables.className = "chapter__meta";
            tables.textContent = step.tableSummary;
            item.append(tables);
          }

          if (step.tip) {
            const tip = document.createElement("p");
            tip.className = "chapter__tip";
            tip.textContent = step.tip;
            item.append(tip);
          }

          const actions = document.createElement("div");
          actions.className = "chapter__actions";

          if (step.actionUrl) {
            const link = document.createElement("a");
            link.className = "chapter__link";
            link.href = step.actionUrl;
            link.target = "_blank";
            link.rel = "noopener";
            link.textContent = step.actionLabel || "Lancer le mini-jeu";
            actions.append(link);
          }

          const mark = document.createElement("button");
          mark.type = "button";
          mark.className = "chapter__mark";
          mark.textContent = "Marquer comme termin√©";
          mark.setAttribute("aria-pressed", "false");
          mark.addEventListener("click", function () {
            const completed = item.dataset.completed === "true";
            const nextState = !completed;
            item.dataset.completed = nextState ? "true" : "false";
            mark.textContent = nextState ? "Chapitre termin√© ‚úî" : "Marquer comme termin√©";
            mark.setAttribute("aria-pressed", nextState ? "true" : "false");
          });
          actions.append(mark);

          item.append(actions);
          return item;
        }

        function estimateTotal(level) {
          if (!level || !Array.isArray(level.steps)) {
            return 0;
          }
          return level.steps.reduce(function (sum, step) {
            return sum + (typeof step.duration === "number" ? step.duration : 0);
          }, 0);
        }

        function formatStory(template) {
          if (!template) {
            return "";
          }
          if (!selectedHero) {
            return template;
          }
          return template.replace(/\{hero\}/g, selectedHero.name);
        }

        function buildCharacters() {
          return [
            {
              id: "chevalier",
              name: "Chevalier Ardent",
              role: "Bouclier √©tincelant",
              description: "Courageux et loyal, il d√©fend chaque village avec son √©p√©e lumineuse.",
              image: "assets/chevalier.png",
              alt: "Chevalier Ardent brandissant son √©p√©e"
            },
            {
              id: "magicienne",
              name: "Magicienne Solaire",
              role: "Sorts de lumi√®re",
              description: "Ses runes brillent autant que ses id√©es pour r√©soudre les √©nigmes.",
              image: "assets/magicienne.png",
              alt: "Magicienne Solaire invoquant un sort"
            },
            {
              id: "exploratrice",
              name: "Exploratrice Stella",
              role: "Strat√©gies malignes",
              description: "Elle cartographie chaque recoin et trouve le chemin le plus malin.",
              image: "assets/princesse.png",
              alt: "Exploratrice Stella observant une carte √©toil√©e"
            }
          ];
        }

        function buildLevels() {
          return [
            {
              id: "1",
              label: "Niveau 1",
              shortName: "For√™t des Apprentis",
              range: "Tables 1 √† 3, avec un soup√ßon de 4",
              summary: "Id√©al pour consolider les bases en douceur.",
              intro: "Les feux follets ont vol√© le cristal du village. {hero} doit le r√©cup√©rer avant que la nuit ne tombe.",
              conclusion: "Gr√¢ce √† sa t√©nacit√©, {hero} ram√®ne le cristal et la for√™t s'illumine de nouveau.",
              steps: [
                {
                  id: "grimoire",
                  title: "Veill√©e au camp",
                  narrative: "{hero} rassemble les fragments du grimoire pour retrouver la trace des lucioles voleuses.",
                  duration: 3,
                  game: "Memory multi",
                  actionLabel: "Ouvrir Memory multi",
                  actionUrl: buildMemoryUrl(2),
                  tableSummary: "Table cibl√©e : 2 (rappels des tables 1 et 3).",
                  tip: "Assemble les 6 paires pour reconstituer la carte lumineuse."
                },
                {
                  id: "clairiere",
                  title: "Course dans la clairi√®re",
                  narrative: "En suivant les lucioles, {hero} r√©cite les sorts des tables 1 √† 3 pour ouvrir les portails.",
                  duration: 3,
                  game: "Roulette magique",
                  actionLabel: "Lancer Roulette magique",
                  actionUrl: buildRouletteUrl([1, 2, 3]),
                  tableSummary: "Tables 1 √† 3, avec quelques d√©fis de la table 4.",
                  tip: "15 secondes par question, ne laisse pas la clairi√®re s'assombrir !"
                },
                {
                  id: "pont",
                  title: "L'esprit du pont",
                  narrative: "Le gardien de pierre teste {hero} avec des affirmations de multiplication.",
                  duration: 3,
                  game: "Duel Vrai ou Faux",
                  actionLabel: "D√©fier l'esprit",
                  actionUrl: buildTrueFalseUrl([1, 2, 3, 4], "apprenti"),
                  tableSummary: "Tables 1 √† 3 et quelques touches de la table 4.",
                  tip: "Tu disposes de 12 secondes pour valider chaque sort."
                }
              ]
            },
            {
              id: "2",
              label: "Niveau 2",
              shortName: "Montagnes Obsidiennes",
              range: "Tables 4 √† 6, avec une pointe de 7",
              summary: "Parfait pour gagner en rythme avant les grands d√©fis.",
              intro: "Les trolls de pierre ont bloqu√© les mines obsidiennes. {hero} doit rouvrir le passage avant la prochaine lune.",
              conclusion: "{hero} lib√®re les cristaux et les mineurs peuvent √† nouveau voyager.",
              steps: [
                {
                  id: "sentinelles",
                  title: "Sentinelles de pierre",
                  narrative: "{hero} r√©cup√®re les runes aupr√®s des statues pour ouvrir la montagne.",
                  duration: 3,
                  game: "Memory multi",
                  actionLabel: "Ouvrir Memory multi",
                  actionUrl: buildMemoryUrl(5),
                  tableSummary: "Table cibl√©e : 5 (rappels des tables 4 √† 6).",
                  tip: "Retrouve vite les 6 paires gard√©es par les trolls."
                },
                {
                  id: "ascension",
                  title: "Ascension des Montagnes Obsidiennes",
                  narrative: "Chaque cavit√© s'ouvre en r√©citant les tables 4 √† 6 avec pr√©cision.",
                  duration: 3,
                  game: "Roulette magique",
                  actionLabel: "Lancer Roulette magique",
                  actionUrl: buildRouletteUrl([4, 5, 6]),
                  tableSummary: "Tables 4 √† 6 avec quelques incursions de la table 7.",
                  tip: "15 secondes par question : maintiens le rythme d'un chevalier."
                },
                {
                  id: "coeur",
                  title: "Le c≈ìur de la montagne",
                  narrative: "Le golem final v√©rifie les calculs avant de rel√¢cher la gemme.",
                  duration: 3,
                  game: "Duel Vrai ou Faux",
                  actionLabel: "Affronter le golem",
                  actionUrl: buildTrueFalseUrl([4, 5, 6, 7], "chevalier"),
                  tableSummary: "Tables 4 √† 6 et quelques questions de la table 7.",
                  tip: "8 secondes par question, reste concentr√© jusqu'au bout."
                }
              ]
            },
            {
              id: "3",
              label: "Niveau 3",
              shortName: "D√©sert des Chim√®res",
              range: "Tables 7 √† 9 uniquement",
              summary: "Une mission intense pour ma√Ætriser les tables √©lev√©es.",
              intro: "Le d√©sert des Chim√®res menace d'engloutir l'oasis sacr√©e. {hero} doit sceller la faille avant le coucher du soleil.",
              conclusion: "Le dragon apaise la temp√™te et {hero} gagne une relique ancestrale.",
              steps: [
                {
                  id: "ruines",
                  title: "Ruines des chim√®res",
                  narrative: "{hero} r√©cup√®re les glyphes oubli√©s du d√©sert br√ªlant.",
                  duration: 3,
                  game: "Memory multi",
                  actionLabel: "Ouvrir Memory multi",
                  actionUrl: buildMemoryUrl(8),
                  tableSummary: "Table cibl√©e : 8 (rappels des tables 7 √† 9).",
                  tip: "Assemble les paires avant que la temp√™te de sable n'arrive."
                },
                {
                  id: "mirages",
                  title: "Course √† travers les mirages",
                  narrative: "Les chim√®res invoquent des mirages multipli√©s, {hero} doit r√©pondre vite.",
                  duration: 3,
                  game: "Roulette magique",
                  actionLabel: "Lancer Roulette magique",
                  actionUrl: buildRouletteUrl([7, 8, 9]),
                  tableSummary: "Tables 7 √† 9 uniquement.",
                  tip: "15 secondes par question, garde ton sang-froid."
                },
                {
                  id: "temple",
                  title: "Temple du dragon sableux",
                  narrative: "Le dragon du d√©sert lance des affirmations br√ªlantes.",
                  duration: 3,
                  game: "Duel Vrai ou Faux",
                  actionLabel: "Affronter le dragon",
                  actionUrl: buildTrueFalseUrl([7, 8, 9], "dragon"),
                  tableSummary: "Tables 7 √† 9 uniquement.",
                  tip: "5 secondes par question : r√©ponds sans h√©siter !"
                }
              ]
            }
          ];
        }

        function buildMemoryUrl(table) {
          const value = Number(table);
          if (!Number.isInteger(value) || value < 1 || value > 10) {
            return "memory.html";
          }
          return `memory.html?table=${value}`;
        }

        function buildRouletteUrl(tables) {
          const values = sanitizeTables(tables);
          if (!values.length) {
            return "jeu.html";
          }
          return `jeu.html?mode=classic&tables=${values.join(",")}`;
        }

        function buildTrueFalseUrl(tables, difficulty) {
          const values = sanitizeTables(tables);
          let url = "vf.html";
          if (values.length) {
            url += `?tables=${values.join(",")}`;
          }
          if (difficulty) {
            url += values.length ? `&difficulty=${encodeURIComponent(difficulty)}` : `?difficulty=${encodeURIComponent(difficulty)}`;
          }
          return url;
        }

        function sanitizeTables(list) {
          if (!Array.isArray(list)) {
            return [];
          }
          const seen = {};
          const result = [];
          list.forEach(function (value) {
            const number = Number(value);
            if (Number.isInteger(number) && number >= 1 && number <= 10 && !seen[number]) {
              seen[number] = true;
              result.push(number);
            }
          });
          result.sort(function (a, b) {
            return a - b;
          });
          return result;
        }
      })();
    </script>
  </body>
</html>
